<% unless iframe_only %>
with( ZendeskApps.AppScope.create() ) {
  require.modules = {
    <% modules.each do |path, content| %>
      <%= path.to_json %>: function(exports, require, module) {
        <%= content %>
      },
    <% end %>
    <% if is_es2015 %>
      '_root.js': function(exports, require, module) {
        <%= source %>
      }
    <% else %>
    eom: undefined
    <% end %>
  };

  var source =<% if is_es2015 %>require('_root')<% else %> <%= source %><% end %>;

  var app = ZendeskApps.defineApp(source)
    .reopenClass(<%= app_settings.to_json %>)
    .reopen({
      appName: <%= name.to_json %>,
      appVersion: <%= version.to_json %>,
      assetUrlPrefix: <%= asset_url_prefix.to_json %>,
      appClassName: <%= app_class_name.to_json %>,
      author: {
        name: <%= author['name'].to_json %>,
        email: <%= author['email'].to_json %>
      },
      translations: <%= translations.to_json %>,
      templates: <%= templates.to_json %>,
      frameworkVersion: <%= framework_version.to_json %>
    });

  ZendeskApps[<%= name.to_json %>] = app;
}
<% end %>
var app = ZendeskApps.defineApp(<%= iframe_only ? 'null' : 'source' %>)
  .reopenClass(<%= app_settings.to_json %>)
  .reopen({
    appName: <%= name.to_json %>,
    appVersion: <%= version.to_json %>,
    assetUrlPrefix: <%= asset_url_prefix.to_json %>,
    appClassName: <%= app_class_name.to_json %>,
    author: {
      name: <%= author['name'].to_json %>,
      email: <%= author['email'].to_json %>
    },
    <% unless iframe_only %>
    translations: <%= translations.to_json %>,
    templates: <%= templates.to_json %>,
    <% end %>
    frameworkVersion: <%= framework_version.to_json %>
  });

ZendeskApps[<%= name.to_json %>] = app;
